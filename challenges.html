<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Challenges ‚Äì SpendSomeTime</title>

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="gamification.js" defer></script>

<style>
:root {
  --bg:#f0f7ff;
  --panel:#ffffffcc;
  --border:#d0e4ff;
  --accent:#ff7eb9;
  --accent2:#58d9ff;
  --text:#1a1a1a;
  --muted:#555555;
  --success:#4ade80;
  --warning:#fbbf24;
  --shadow: rgba(0,0,0,0.1);
}

* {
  box-sizing:border-box;
  font-family:'Inter', system-ui, sans-serif;
  scroll-behavior: smooth;
}

body {
  margin:0;
  background: var(--bg);
  color: var(--text);
}

nav {
  position: fixed;
  top: 0;
  width: 100%;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  border-bottom: 1px solid var(--border);
  padding: 1rem 2rem;
  z-index: 1000;
  box-shadow: 0 2px 10px var(--shadow);
}

nav .nav-content {
  max-width: 1200px;
  margin: 0 auto;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

nav .logo {
  font-size: 1.3rem;
  font-weight: 700;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
  text-decoration: none;
}

nav .nav-links {
  display: flex;
  gap: 1.5rem;
  align-items: center;
}

nav .nav-links a {
  color: var(--text);
  text-decoration: none;
  font-weight: 600;
  font-size: 0.9rem;
  transition: color 0.3s ease;
}

nav .nav-links a:hover {
  color: var(--accent2);
}

main {
  max-width:1000px;
  margin:0 auto;
  padding:3rem 1.5rem;
  margin-top: 80px;
}

.view-toggle {
  display: flex;
  gap: 0.5rem;
  margin: 1rem 0;
  justify-content: flex-end;
  flex-wrap: wrap;
}

.view-toggle button {
  padding: 0.6rem 1.2rem;
  border: 2px solid var(--border);
  background: var(--panel);
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
  font-size: 0.9rem;
}

.view-toggle button:hover {
  border-color: var(--accent2);
  color: var(--accent2);
}

.view-toggle button.active {
  background: linear-gradient(135deg, var(--accent2), var(--accent));
  color: white;
  border-color: transparent;
  box-shadow: 0 4px 12px rgba(88, 217, 255, 0.3);
}

.calendar-view {
  display: none;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 2rem;
  margin: 2rem 0;
  box-shadow: 0 6px 20px var(--shadow);
}

.calendar-view.active {
  display: block;
}

.calendar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
}

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 0.5rem;
}

.calendar-day {
  aspect-ratio: 1;
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 0.5rem;
  font-size: 0.85rem;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: white;
  min-height: 50px;
}

.calendar-day.weekday {
  font-weight: 700;
  background: var(--bg);
  border: 2px solid var(--accent2);
  color: var(--accent2);
  font-size: 0.8rem;
}

.calendar-day.has-activity {
  background: var(--accent2);
  color: white;
  border-color: var(--accent2);
  font-weight: 600;
}

.calendar-day.today {
  border: 2px solid var(--accent);
  font-weight: 700;
}

.progress-chart {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 2rem;
  margin: 2rem 0;
  box-shadow: 0 6px 20px var(--shadow);
}

.chart-bar {
  display: flex;
  align-items: center;
  margin: 1rem 0;
  gap: 1rem;
}

.chart-bar-label {
  min-width: 150px;
  font-weight: 600;
  color: var(--accent2);
  text-align: right;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.chart-bar-fill {
  flex: 1;
  height: 30px;
  background: var(--border);
  border-radius: 15px;
  overflow: hidden;
  position: relative;
}

.chart-bar-progress {
  height: 100%;
  background: linear-gradient(90deg, var(--accent2), var(--accent));
  border-radius: 15px;
  transition: width 0.5s ease;
  display: flex;
  align-items: center;
  justify-content: flex-end;
  padding-right: 0.5rem;
  color: white;
  font-size: 0.85rem;
  font-weight: 600;
  min-width: 35px;
}

.notes-section {
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid var(--border);
}

.note-item {
  background: #f8f9ff;
  border-radius: 8px;
  padding: 0.8rem;
  margin: 0.5rem 0;
  font-size: 0.9rem;
}

.note-date {
  font-size: 0.75rem;
  color: var(--muted);
  margin-bottom: 0.3rem;
}

.milestone {
  display: inline-block;
  padding: 0.4rem 0.9rem;
  background: linear-gradient(135deg, var(--success), #22c55e);
  color: white;
  border-radius: 12px;
  font-size: 0.8rem;
  font-weight: 700;
  margin: 0.5rem 0.3rem 0 0;
  animation: slideInUp 0.5s ease-out;
}

@keyframes slideInUp {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.achievement-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 1rem;
  margin: 2rem 0;
}

.achievement-card {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 1.5rem;
  text-align: center;
  box-shadow: 0 4px 12px var(--shadow);
  transition: transform 0.3s ease, border-color 0.3s ease;
  opacity: 0.6;
}

.achievement-card:hover {
  transform: translateY(-4px);
}

.achievement-card.unlocked {
  opacity: 1;
  border-color: var(--success);
  background: linear-gradient(135deg, #ffffff, #f0fdf4);
  box-shadow: 0 8px 20px rgba(74, 222, 128, 0.2);
}

.achievement-icon {
  font-size: 3rem;
  margin-bottom: 0.5rem;
}

.achievement-title {
  font-weight: 600;
  color: var(--accent2);
  margin-bottom: 0.5rem;
}

.achievement-desc {
  font-size: 0.85rem;
  color: var(--muted);
}

h1 {
  font-size:2.8rem;
  margin-bottom:1rem;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
}

.stats-bar {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 1rem;
  margin: 2rem 0;
}

.stat-card {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 1.5rem;
  text-align: center;
  box-shadow: 0 4px 12px var(--shadow);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.stat-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 20px rgba(88, 217, 255, 0.15);
}

.stat-card .value {
  font-size: 2rem;
  font-weight: 700;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 0.5rem;
}

.stat-card .label {
  font-size: 0.9rem;
  color: var(--muted);
  font-weight: 500;
}

.tabs {
  display: flex;
  gap: 0.5rem;
  margin: 2rem 0;
  flex-wrap: wrap;
  border-bottom: 2px solid var(--border);
  padding-bottom: 1rem;
}

.tab {
  padding: 0.8rem 1.5rem;
  border-radius: 10px 10px 0 0;
  border: 2px solid transparent;
  background: transparent;
  color: var(--text);
  cursor: pointer;
  font-weight: 600;
  transition: all 0.25s ease;
}

.tab:hover {
  color: var(--accent2);
  transform: translateY(-2px);
}

.tab.active {
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: white;
  border-color: transparent;
}

.challenge {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 2rem;
  margin-bottom: 1.5rem;
  box-shadow: 0 6px 20px var(--shadow);
  transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
  position: relative;
  overflow: hidden;
}

.challenge:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 32px rgba(88, 217, 255, 0.15);
  border-color: var(--accent2);
}

.challenge.completed {
  border-color: var(--success);
  background: linear-gradient(135deg, #ffffff, #f0fdf4);
}

.challenge.completed::before {
  content: "‚úì";
  position: absolute;
  top: 1rem;
  right: 1rem;
  width: 40px;
  height: 40px;
  background: var(--success);
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  font-weight: 700;
  box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
}

.challenge-header {
  display: flex;
  justify-content: space-between;
  align-items: start;
  margin-bottom: 1rem;
  flex-wrap: wrap;
  gap: 1rem;
}

.challenge-header h3 {
  margin: 0;
  color: var(--accent2);
  font-size: 1.5rem;
}

.challenge-status {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.status-badge {
  padding: 0.4rem 1rem;
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.status-badge.active {
  background: linear-gradient(135deg, #58d9ff, #2ec9ff);
  color: white;
}

.status-badge.completed {
  background: linear-gradient(135deg, #4ade80, #22c55e);
  color: white;
}

.status-badge.paused {
  background: linear-gradient(135deg, #fbbf24, #f59e0b);
  color: white;
}

.progress-container {
  margin: 1rem 0;
}

.progress-label {
  display: flex;
  justify-content: space-between;
  margin-bottom: 0.5rem;
  font-size: 0.9rem;
  color: var(--muted);
}

.progress-bar {
  height: 12px;
  background: var(--border);
  border-radius: 6px;
  overflow: hidden;
  position: relative;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent2), var(--accent));
  border-radius: 6px;
  transition: width 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  box-shadow: 0 2px 8px rgba(88, 217, 255, 0.3);
}

.challenge-description {
  color: var(--muted);
  margin: 1rem 0;
  line-height: 1.6;
}

.challenge-actions {
  display: flex;
  gap: 0.75rem;
  margin-top: 1.5rem;
  flex-wrap: wrap;
}

.btn {
  padding: 0.7rem 1.5rem;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.25s ease;
  font-size: 0.9rem;
}

.btn:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.btn:active:not(:disabled) {
  transform: translateY(0);
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.btn-primary {
  background: var(--accent2);
  color: white;
}

.btn-primary:hover {
  background: #2ec9ff;
  transform: scale(1.02);
}

.btn-secondary {
  background: transparent;
  border: 2px solid var(--border);
  color: var(--text);
}

.btn-secondary:hover {
  border-color: var(--accent2);
  color: var(--accent2);
  background: rgba(88, 217, 255, 0.05);
}

.btn-success {
  background: var(--success);
  color: white;
}

.btn-success:hover {
  transform: scale(1.02);
  box-shadow: 0 4px 12px rgba(74, 222, 128, 0.3);
  background: #22c55e;
}

.btn-danger {
  background: #ef4444;
  color: white;
}

.btn-danger:hover {
  transform: scale(1.02);
  background: #dc2626;
}

.streak-indicator {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  background: linear-gradient(135deg, #fef3c7, #fcd34d);
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: 700;
  color: #92400e;
  border: 1px solid #fbbf24;
  animation: pulse 2s ease-in-out infinite;
}

.streak-indicator .fire {
  font-size: 1.2rem;
  display: inline-block;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

.empty-state {
  text-align: center;
  padding: 4rem 2rem;
  background: linear-gradient(135deg, #f0fdf4, #f0f7ff);
  border: 2px dashed var(--border);
  border-radius: 16px;
  margin: 2rem 0;
}

.empty-state h3 {
  color: var(--accent2);
  margin-bottom: 1rem;
  font-size: 1.5rem;
}

.empty-state p {
  color: var(--muted);
  margin-bottom: 2rem;
  font-size: 1rem;
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.4);
  backdrop-filter: blur(4px);
  z-index: 1000;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.2s ease-in;
}

@keyframes fadeIn {
  from { background: rgba(0,0,0,0); opacity: 0; }
  to { background: rgba(0,0,0,0.4); opacity: 1; }
}

.modal.active {
  display: flex;
}

.modal-content {
  background: white;
  border-radius: 16px;
  padding: 2rem;
  max-width: 500px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  animation: slideUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes slideUp {
  from { transform: translateY(30px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.modal-content h3 {
  margin-top: 0;
  color: var(--accent2);
  margin-bottom: 1.5rem;
}

.modal-content input,
.modal-content textarea,
.modal-content select {
  width: 100%;
  padding: 0.8rem;
  border: 1px solid var(--border);
  border-radius: 8px;
  margin: 0.5rem 0 1rem 0;
  font-family: inherit;
  font-size: 1rem;
  transition: border-color 0.3s ease;
}

.modal-content input:focus,
.modal-content textarea:focus,
.modal-content select:focus {
  outline: none;
  border-color: var(--accent2);
  box-shadow: 0 0 0 3px rgba(88, 217, 255, 0.1);
}

.modal-content textarea {
  min-height: 100px;
  resize: vertical;
}

.modal-content label {
  display: block;
  font-weight: 600;
  color: var(--accent2);
  margin-top: 1rem;
  margin-bottom: 0.5rem;
}

.modal-actions {
  display: flex;
  gap: 1rem;
  justify-content: flex-end;
  margin-top: 1.5rem;
  flex-wrap: wrap;
}

.modal-actions .btn {
  flex: 1;
  min-width: 120px;
}

.achievement-badge {
  display: inline-block;
  padding: 0.3rem 0.8rem;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: white;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 600;
  margin: 0.3rem 0.3rem 0 0;
}

/* XP and Theme Styles */
.xp-section {
  display: flex;
  gap: 1.5rem;
  align-items: center;
  padding: 1rem 1.5rem;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  border-radius: 12px;
  color: white;
  margin-bottom: 1.5rem;
  box-shadow: 0 4px 16px var(--shadow);
}

.xp-display {
  display: flex;
  gap: 0.5rem;
  align-items: center;
  font-weight: 700;
  font-size: 1.3rem;
  margin-right: auto;
}

.xp-display-icon {
  font-size: 1.8rem;
  animation: pulse 0.6s ease-in-out;
}

.theme-selector-btn {
  padding: 0.6rem 1.2rem;
  background: white;
  color: var(--accent2);
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.theme-selector-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.theme-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 2000;
  align-items: center;
  justify-content: center;
}

.theme-modal.active {
  display: flex;
}

.theme-modal-content {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 2rem;
  max-width: 600px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 20px 60px var(--shadow);
  position: relative;
}

.theme-modal-content h2 {
  margin-top: 0;
  color: var(--accent2);
}

.theme-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 1rem;
  margin: 1.5rem 0;
}

.theme-card {
  background: var(--panel);
  border: 2px solid var(--border);
  border-radius: 12px;
  padding: 1.5rem;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  min-height: 180px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.theme-card:hover:not(.theme-card.locked) {
  border-color: var(--accent2);
  transform: translateY(-4px);
  box-shadow: 0 8px 24px var(--shadow);
}

.theme-card.active {
  border-color: var(--accent);
  background: linear-gradient(135deg, rgba(88, 217, 255, 0.1), rgba(255, 126, 185, 0.1));
  box-shadow: 0 0 0 3px var(--accent2);
}

.theme-card.locked {
  opacity: 0.6;
  cursor: not-allowed;
}

.theme-card .theme-preview {
  width: 60px;
  height: 60px;
  border-radius: 8px;
  margin-bottom: 0.8rem;
  box-shadow: 0 2px 8px var(--shadow);
}

.theme-card .theme-name {
  font-weight: 600;
  color: var(--text);
  margin-bottom: 0.3rem;
}

.theme-card .theme-cost {
  font-size: 0.85rem;
  color: var(--muted);
  margin-bottom: 0.5rem;
}

.theme-card .theme-status {
  font-size: 0.75rem;
  font-weight: 600;
  padding: 0.3rem 0.8rem;
  border-radius: 12px;
  background: var(--accent2);
  color: white;
}

.theme-card.locked .theme-status {
  background: #ccc;
  color: #666;
}

.unlock-btn {
  width: 100%;
  padding: 0.7rem;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: white;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 0.8rem;
  transition: all 0.3s ease;
}

.unlock-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px var(--shadow);
}

.unlock-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.theme-modal-close {
  position: absolute;
  top: 1rem;
  right: 1rem;
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  color: var(--muted);
  transition: color 0.3s ease;
}

.theme-modal-close:hover {
  color: var(--text);
}

.xp-toast {
  position: fixed;
  bottom: 2rem;
  right: 2rem;
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: white;
  padding: 1rem 1.5rem;
  border-radius: 12px;
  box-shadow: 0 8px 24px var(--shadow);
  animation: slideInUp 0.5s ease;
  z-index: 3000;
}

@keyframes slideInUp {
  from {
    transform: translateY(100px);
    opacity: 0;
  }
  to {
    transform: translateY(0);
    opacity: 1;
  }
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.2); }
}

@keyframes popIn {
  from {
    transform: translate(-50%, -50%) scale(0);
    opacity: 0;
  }
  to {
    transform: translate(-50%, -50%) scale(1);
    opacity: 1;
  }
}

footer {
  background: rgba(255, 255, 255, 0.95);
  border-top: 1px solid var(--border);
  padding: 2rem 1.5rem;
  text-align: center;
  color: var(--muted);
  font-size: 0.9rem;
  margin-top: 4rem;
}

footer a {
  color: var(--accent2);
  text-decoration: none;
  font-weight: 600;
  text-align: center;
  border-style: justify;
}

footer a:hover {
  text-decoration: underline;
}

@media (max-width:600px){
  h1{font-size:2rem;}
  .challenge{padding:1.5rem;}
  .challenge-header{flex-direction:column;}
  .stats-bar{grid-template-columns:1fr;}
  .calendar-grid{gap:0.25rem;}
  .calendar-day{font-size:0.75rem; padding:0.25rem;}
  .chart-bar-label{min-width:100px; font-size:0.85rem;}
  .view-toggle{flex-wrap:wrap;}
  .view-toggle button{padding:0.5rem 0.8rem; font-size:0.85rem;}
  .tabs{gap:0.3rem;}
  .tab{padding:0.6rem 1rem; font-size:0.85rem;}
  .modal-content{padding:1.5rem;}
  .challenge-actions{flex-direction:column;}
  .challenge-actions .btn{width:100%;}
}
/* Mobile-first overrides */
@media (max-width: 768px) {
  header h1 {
    font-size: 2.5rem;
  }
  header p {
    font-size: 1rem;
    max-width: 90%;
  }
  .actions {
    flex-direction: column;
    gap: 0.8rem;
    align-items: center;
  }
  a.button {
    width: 90%;
    max-width: 250px;
  }
  .stats-banner, .quick-actions {
    grid-template-columns: 1fr;
    gap: 1rem;
    padding: 1rem;
  }
  .card {
    padding: 1.5rem;
  }
  .card h2 { font-size: 1.4rem; }
  .card p { font-size: 0.95rem; }
  footer {
    padding: 1rem;
    font-size: 0.85rem;
  }
  nav .nav-links {
    flex-wrap: wrap;
    justify-content: center;
    gap: 0.5rem;
  }
}
@media (max-width: 600px) {
  header {
    padding: 2rem 1rem;
  }
  .scroll-indicator {
    bottom: 1rem;
    font-size: 1.5rem;
  }
}
.stats-banner, .quick-actions {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 2rem;
}

@media (max-width: 600px) {
  .stats-banner, .quick-actions {
    grid-template-columns: 1fr;
    gap: 1rem;
    padding: 1rem;
  }
}
#lesson-complete-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.75);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 10000;
}

.lesson-complete-card {
  background: white;
  padding: 2.5rem 3rem;
  border-radius: 24px;
  text-align: center;
  animation: slamIn 0.45s cubic-bezier(.2,1.5,.4,1);
  box-shadow: 0 25px 60px rgba(0,0,0,0.3);
}

.lesson-emoji {
  font-size: 72px;
  margin-bottom: 0.75rem;
  animation: wobble 1s infinite ease-in-out;
}

.lesson-sub {
  margin-top: 0.5rem;
  font-size: 0.9rem;
  color: var(--muted);
}

@keyframes slamIn {
  from {
    transform: scale(0.4) rotate(-8deg);
    opacity: 0;
  }
  to {
    transform: scale(1) rotate(0);
    opacity: 1;
  }
}

@keyframes wobble {
  0% { transform: rotate(-8deg); }
  50% { transform: rotate(8deg); }
  100% { transform: rotate(-8deg); }
}
#lesson-complete-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.75);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.lesson-complete-card {
  background: #fff;
  border-radius: 16px;
  padding: 2rem;
  width: 320px;
  max-width: 90%;
  text-align: center;
  transform: scale(0);
  opacity: 0;
  font-family: sans-serif;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

.lesson-emoji {
  font-size: 3rem;
  margin-bottom: 0.5rem;
  display: inline-block;
  transform: rotate(0deg);
}

#lesson-complete-text {
  font-size: 1.2rem;
  margin: 0.5rem 0;
}

.lesson-sub {
  font-size: 0.9rem;
  color: #555;
}
.lesson-complete-card {
  transform-origin: center;
  perspective: 800px;
}

.main-icon {
  font-size: 48px;
  margin-bottom: 12px;
  display: inline-block;
}

.icon-burst {
  position: absolute;
  inset: 0;
  pointer-events: none;
}

.burst-icon {
  position: absolute;
  font-size: 20px;
  opacity: 0;
}
.duo-icon {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  background: #58cc02; /* Duolingo green */
  color: white;
  font-size: 36px;
  font-weight: 900;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 12px;
}

.sparkles {
  position: absolute;
  inset: 0;
  pointer-events: none;
}

.sparkle {
  position: absolute;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #58cc02;
  opacity: 0;
}

</style>
</head>
<body>

<nav>
  <div class="nav-content">
    <a href="index.html" class="logo">SpendSomeTime</a>
    <div class="nav-links">
      <a href="index.html">Home</a>
      <a href="skills.html">Skills</a>
        <a href="challenges.html">Track Challenges</a>
      <a href="weird.html">Quick Skills</a>
      <a href="games.html">Games</a>
            <a href="diagram.html">All Skills</a>
    </div>
  </div>
</nav>

<main>
  <h1>My Learning Challenges</h1>
  <p>Turn your quiz results into actionable challenges. Track your progress and celebrate your wins!</p>

  <!-- XP Display Section -->
  <div class="xp-section">
    <div class="xp-display">
      <span class="xp-display-icon">‚≠ê</span>
      <span id="xp-total">0 XP</span>
    </div>
    <button class="theme-selector-btn" onclick="openThemeSelector()">üé® Themes</button>
  </div>

  <div class="view-toggle">
    <button class="active" data-view="list" onclick="switchView('list', event)">üìã List View</button>
    <button data-view="calendar" onclick="switchView('calendar', event)">üìÖ Calendar</button>
    <button data-view="chart" onclick="switchView('chart', event)">üìä Progress Chart</button>
    <button data-view="achievements" onclick="switchView('achievements', event)">üèÜ Achievements</button>
  </div>

  <div class="stats-bar">
    <div class="stat-card">
      <div class="value" id="total-challenges">0</div>
      <div class="label">Total Challenges</div>
    </div>
    <div class="stat-card">
      <div class="value" id="active-challenges">0</div>
      <div class="label">Active</div>
    </div>
    <div class="stat-card">
      <div class="value" id="completed-challenges">0</div>
      <div class="label">Completed</div>
    </div>
    <div class="stat-card">
      <div class="value" id="current-streak">0</div>
      <div class="label">Day Streak üî•</div>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" data-filter="all">All Challenges</button>
    <button class="tab" data-filter="active">Active</button>
    <button class="tab" data-filter="completed">Completed</button>
    <button class="tab" data-filter="paused">Paused</button>
  </div>

  <div id="challenges-container"></div>

  <div class="empty-state" id="empty-state" style="display:none;">
    <h3>No Challenges Yet</h3>
    <p>Start by selecting skills from your quiz results or create a custom challenge!</p>
    <button class="btn btn-primary" onclick="openAddModal()">Create Your First Challenge</button>
  </div>

  <div id="calendar-view" class="calendar-view"></div>
  <div id="chart-view" class="progress-chart" style="display:none;"></div>
  <div id="achievements-view" class="achievement-grid" style="display:none;"></div>

  <div style="text-align:center; margin-top:3rem;">
    <button class="btn btn-primary" onclick="openAddModal()">+ Add New Challenge</button>
    <button class="btn btn-secondary" onclick="loadFromQuiz()" style="margin-left:1rem;">Import from Quiz Results</button>
    <button class="btn btn-secondary" onclick="exportProgress()" style="margin-left:1rem;">Export Progress</button>
    <button class="btn btn-secondary" onclick="shareToday()" style="margin-left:1rem;" id="shareBtn">Share today‚Äôs challenge</button>
  </div>
</main>

<!-- Add/Edit Challenge Modal -->
<div class="modal" id="challenge-modal">
  <div class="modal-content">
    <h3 id="modal-title">Create New Challenge</h3>
    <form id="challenge-form">
      <label>Challenge Name</label>
      <input type="text" id="challenge-name" required placeholder="e.g., Learn Basic Spanish">
      
      <label>Description</label>
      <textarea id="challenge-description" required placeholder="What will you learn? What's your goal?"></textarea>
      
      <label>Target Duration (days)</label>
      <input type="number" id="challenge-duration" min="1" value="30" required>
      
      <label>Daily Time Commitment (minutes)</label>
      <input type="number" id="challenge-daily-time" min="5" value="30" required>
      
      <label>Learning Resource URL</label>
      <input type="url" id="challenge-url" placeholder="https://...">
      
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button type="submit" class="btn btn-primary">Create Challenge</button>
      </div>
    </form>
  </div>
</div>


<!-- Progress Update Modal -->
<div class="modal" id="progress-modal">
  <div class="modal-content">
    <h3>Update Progress</h3>
    <form id="progress-form">
      <label>Time Spent Today (minutes)</label>
      <input type="number" id="progress-time" min="1" required>
      
      <label>What did you learn today?</label>
      <textarea id="progress-notes" placeholder="Optional notes about your progress..."></textarea>
      
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" onclick="closeProgressModal()">Cancel</button>
        <button type="submit" class="btn btn-success">Update Progress</button>
      </div>
    </form>
  </div>
</div>

<!-- Theme Selector Modal -->
<div class="theme-modal" id="theme-modal">
  <div class="theme-modal-content">
    <button class="theme-modal-close" onclick="closeThemeSelector()">‚úï</button>
    <h2>Select Your Theme</h2>
    <p>Choose a theme to customize your SpendSomeTime experience</p>
    <div class="theme-grid" id="theme-grid"></div>
  </div>
</div>

<script>
let challenges = JSON.parse(localStorage.getItem('challenges') || '[]');
let currentFilter = 'all';
let editingChallengeId = null;
let progressChallengeId = null;


function getChallengeById(id) {
  return challenges.find(c => c.id === Number(id));
}

// Initialize
updateStats();
renderChallenges();
setupTabs();

// Load challenges from quiz results (bookmarked skills)
function loadFromQuiz() {
  const bookmarked = JSON.parse(localStorage.getItem('bookmarkedSkills') || '[]');
  if(bookmarked.length === 0) {
    alert('No bookmarked skills found! Complete a quiz and bookmark some skills first.');
    return;
  }
  

  // Try to load from skills.json or weird.json
  Promise.all([
    fetch('skills.json').then(r => r.ok ? r.json() : []).catch(() => []),
    fetch('weird.json').then(r => r.ok ? r.json() : []).catch(() => [])
  ]).then(([skills, weird]) => {
    const allSkills = [...skills, ...weird];
    const bookmarkedSkills = allSkills.filter(s => bookmarked.includes(s.name));
    
    if(bookmarkedSkills.length === 0) {
      alert('Could not find bookmarked skills in database.');
      return;
    }
    
    // Create challenges from bookmarked skills
    bookmarkedSkills.forEach(skill => {
      const challenge = {
        id: Date.now() + Math.random(),
        name: skill.name,
        description: skill.description || skill.reason || 'Learn this skill!',
        url: skill.learn_url || '',
        duration: 30,
        dailyTime: 30,
        status: 'active',
        progress: 0,
        totalTime: 0,
        startDate: new Date().toISOString(),
        lastUpdate: new Date().toISOString(),
        notes: [],
        streak: 0
      };
      challenges.push(challenge);
    });
    
    saveChallenges();
    updateStats();
    renderChallenges();
    alert(`Created ${bookmarkedSkills.length} challenges from your bookmarked skills!`);
  });
}

function setupTabs() {
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      currentFilter = tab.dataset.filter;
      renderChallenges();
    });
  });
}

function updateStats() {
  const total = challenges.length;
  const active = challenges.filter(c => c.status === 'active').length;
  const completed = challenges.filter(c => c.status === 'completed').length;
  const streak = Math.max(...challenges.map(c => c.streak || 0), 0);
  
  document.getElementById('total-challenges').textContent = total;
  document.getElementById('active-challenges').textContent = active;
  document.getElementById('completed-challenges').textContent = completed;
  document.getElementById('current-streak').textContent = streak;
  
  // Update XP display (safely check if GameSystem is available)
  if (typeof GameSystem !== 'undefined') {
    const totalXP = GameSystem.getTotalXP();
    document.getElementById('xp-total').textContent = totalXP + ' XP';
  }
}

function renderChallenges() {
  const container = document.getElementById('challenges-container');
  const emptyState = document.getElementById('empty-state');
  
  let filtered = challenges;
  if(currentFilter !== 'all') {
    filtered = challenges.filter(c => c.status === currentFilter);
  }
  
  if(filtered.length === 0) {
    container.innerHTML = '';
    emptyState.style.display = challenges.length === 0 ? 'block' : 'none';
    return;
  }
  
  emptyState.style.display = 'none';
  container.innerHTML = '';
  
  filtered.forEach(challenge => {
    const div = document.createElement('div');
    div.className = `challenge ${challenge.status === 'completed' ? 'completed' : ''}`;
    
    const progressPercent = Math.min(100, (challenge.progress / challenge.duration) * 100);
    const daysRemaining = Math.max(0, challenge.duration - challenge.progress);
    
    div.innerHTML = `
      <div class="challenge-header">
        <h3>${challenge.name}</h3>
        <div class="challenge-status">
          ${challenge.streak > 0 ? `<span class="streak-indicator"><span class="fire">üî•</span> ${challenge.streak} day streak</span>` : ''}
          <span class="status-badge ${challenge.status}">${challenge.status.charAt(0).toUpperCase() + challenge.status.slice(1)}</span>
        </div>
      </div>
      
      <p class="challenge-description">${challenge.description}</p>
      
      <div class="progress-container">
        <div class="progress-label">
          <span>Progress: ${challenge.progress} / ${challenge.duration} days</span>
          <span>${daysRemaining} days remaining</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${progressPercent}%"></div>
        </div>
      </div>
      
      <div style="margin-top:1rem; color:var(--muted); font-size:0.9rem;">
        Total time invested: ${Math.floor(challenge.totalTime / 60)} hours ${challenge.totalTime % 60} minutes
      </div>
      
      ${challenge.progress >= challenge.duration * 0.25 ? '<span class="milestone">üèÅ 25%</span>' : ''}
      ${challenge.progress >= challenge.duration * 0.5 ? '<span class="milestone">üèÅ 50%</span>' : ''}
      ${challenge.progress >= challenge.duration * 0.75 ? '<span class="milestone">üèÅ 75%</span>' : ''}
      
      ${challenge.url ? `<p style="margin-top:0.5rem;"><a href="${challenge.url}" target="_blank" style="color:var(--accent2); font-weight:600;">üìñ Learn more ‚Üí</a></p>` : ''}
      
      ${(challenge.notes && Array.isArray(challenge.notes) && challenge.notes.length > 0) ? `
        <div class="notes-section">
          <strong style="color:var(--accent2);">Recent Notes:</strong>
          ${challenge.notes.slice(-3).reverse().map(note => `
            <div class="note-item">
              <div class="note-date">${new Date(note.date).toLocaleDateString()}</div>
              <div>${note.note || `Practiced for ${note.time} minutes`}</div>
            </div>
          `).join('')}
        </div>
      ` : ''}
      
      <div class="challenge-actions">
        ${challenge.status === 'active' ? `
          <button class="btn btn-success" onclick="updateProgress('${challenge.id}')">Log Progress</button>
          <button class="btn btn-primary" onclick="editChallenge('${challenge.id}')">Edit</button>
          <button class="btn btn-secondary" onclick="pauseChallenge('${challenge.id}')">Pause</button>
        ` : challenge.status === 'paused' ? `
          <button class="btn btn-primary" onclick="resumeChallenge('${challenge.id}')">Resume</button>
          <button class="btn btn-secondary" onclick="editChallenge('${challenge.id}')">Edit</button>
        ` : ''}
        <button class="btn btn-danger" onclick="deleteChallenge('${challenge.id}')">Delete</button>
      </div>
    `;
    
    container.appendChild(div);
  });
}

function openAddModal() {
  editingChallengeId = null;
  document.getElementById('modal-title').textContent = 'Create New Challenge';
  document.getElementById('challenge-form').reset();
  document.getElementById('challenge-duration').value = 30;
  document.getElementById('challenge-daily-time').value = 30;
  document.getElementById('challenge-modal').classList.add('active');
}

function closeModal() {
  document.getElementById('challenge-modal').classList.remove('active');
  editingChallengeId = null;
}

function editChallenge(id) {
  const challenge = getChallengeById(id);
  if (!challenge) return;

  editingChallengeId = challenge.id;
  document.getElementById('modal-title').textContent = 'Edit Challenge';
  document.getElementById('challenge-name').value = challenge.name;
  document.getElementById('challenge-description').value = challenge.description;
  document.getElementById('challenge-duration').value = challenge.duration;
  document.getElementById('challenge-daily-time').value = challenge.dailyTime;
  document.getElementById('challenge-url').value = challenge.url || '';
  document.getElementById('challenge-modal').classList.add('active');
}


document.getElementById('challenge-form').addEventListener('submit', (e) => {
  e.preventDefault();
  
  const challenge = {
    id: editingChallengeId || (Date.now() + Math.random()),
    name: document.getElementById('challenge-name').value,
    description: document.getElementById('challenge-description').value,
    duration: parseInt(document.getElementById('challenge-duration').value),
    dailyTime: parseInt(document.getElementById('challenge-daily-time').value),
    url: document.getElementById('challenge-url').value,
    status: editingChallengeId ? challenges.find(c => c.id === editingChallengeId).status : 'active',
    progress: editingChallengeId ? challenges.find(c => c.id === editingChallengeId).progress : 0,
    totalTime: editingChallengeId ? challenges.find(c => c.id === editingChallengeId).totalTime : 0,
    startDate: editingChallengeId ? challenges.find(c => c.id === editingChallengeId).startDate : new Date().toISOString(),
    lastUpdate: editingChallengeId ? challenges.find(c => c.id === editingChallengeId).lastUpdate : new Date().toISOString(),
    notes: editingChallengeId ? (challenges.find(c => c.id === editingChallengeId).notes || []) : [],
    streak: editingChallengeId ? (challenges.find(c => c.id === editingChallengeId).streak || 0) : 0
  };
  
  if(editingChallengeId) {
    const index = challenges.findIndex(c => c.id === editingChallengeId);
    challenges[index] = challenge;
  } else {
    challenges.push(challenge);
  }
  
  saveChallenges();
  updateStats();
  renderChallenges();
  closeModal();
});

function updateProgress(id) {
  progressChallengeId = Number(id);
  document.getElementById('progress-form').reset();
  document.getElementById('progress-modal').classList.add('active');
}


function closeProgressModal() {
  document.getElementById('progress-modal').classList.remove('active');
  progressChallengeId = null;
}

document.getElementById('progress-form').addEventListener('submit', (e) => {
  e.preventDefault();
  
const challenge = getChallengeById(progressChallengeId);

  if(!challenge) return;
  
  const timeSpent = parseInt(document.getElementById('progress-time').value);
  const notes = document.getElementById('progress-notes').value;
  const today = new Date().toISOString().split('T')[0];
  const lastUpdate = new Date(challenge.lastUpdate).toISOString().split('T')[0];
  
  // Update total time
  challenge.totalTime += timeSpent;

  // Increment progress only if not updated today
  if (today !== lastUpdate) {
    challenge.progress += 1;
  }

  challenge.lastUpdate = new Date().toISOString();

  // Update streak based on consecutive days
  if (today === lastUpdate) {
    // Same day, don't change streak
  } else {
    const yesterday = new Date();
    yesterday.setDate(yesterday.getDate() - 1);
    const yesterdayStr = yesterday.toISOString().split('T')[0];
    
    if (lastUpdate === yesterdayStr) {
      // Consecutive day, increment streak
      challenge.streak = (challenge.streak || 0) + 1;
    } else {
      // Day gap, reset streak to 1
      challenge.streak = 1;
    }
  }
  
  // Add note only if there's text
  if (notes) {
    if (!challenge.notes) challenge.notes = [];
    challenge.notes.push({
      date: new Date().toISOString(),
      time: timeSpent,
      note: notes
    });
  }
  
  // Check if completed
  if (challenge.progress >= challenge.duration) {
    challenge.status = 'completed';
    challenge.progress = challenge.duration;
  }
  
  // üéÆ Award XP for logging progress
  GameSystem.awardXP(GameSystem.rewards.logOfflineSession, 'logOfflineSession');
  
  // üéÆ Award bonus XP if challenge is completed
  if (challenge.status === 'completed') {
    GameSystem.awardXP(GameSystem.rewards.completeChallenge, 'completeChallenge');
  }
  
  saveChallenges();
  updateStats();
  renderChallenges();
  closeProgressModal();
  
// üîπ Trigger animation EVERY time progress is logged
setTimeout(() => {
  showLessonCompleteAnimation(challenge.name);
}, 300);

});

function pauseChallenge(id) {
  const challenge = getChallengeById(id);
  if (!challenge) return;

  challenge.status = 'paused';
  saveChallenges();
  updateStats();
  renderChallenges();
}



function resumeChallenge(id) {
  const challenge = getChallengeById(id);
  if (!challenge) return;

  challenge.status = 'active';
  saveChallenges();
  updateStats();
  renderChallenges();
}


function deleteChallenge(id) {
  id = Number(id);
  if (!confirm('Are you sure you want to delete this challenge?')) return;

  challenges = challenges.filter(c => c.id !== id);
  saveChallenges();
  updateStats();
  renderChallenges();
}


function saveChallenges() {
  localStorage.setItem('challenges', JSON.stringify(challenges));
}

function switchView(view, e) {
  document.querySelectorAll('.view-toggle button').forEach(b => b.classList.remove('active'));
  if(e && e.target) {
    e.target.classList.add('active');
  } else {
    document.querySelector(`[data-view="${view}"]`)?.classList.add('active');
  }
  
  document.getElementById('challenges-container').style.display = view === 'list' ? 'block' : 'none';
  document.getElementById('calendar-view').classList.toggle('active', view === 'calendar');
  document.getElementById('chart-view').style.display = view === 'chart' ? 'block' : 'none';
  document.getElementById('achievements-view').style.display = view === 'achievements' ? 'grid' : 'none';
  
  if(view === 'calendar') renderCalendar();
  if(view === 'chart') renderChart();
  if(view === 'achievements') renderAchievements();
}

function renderCalendar() {
  const container = document.getElementById('calendar-view');
  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth();
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  
  const weekdays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
  
  let html = `
    <div class="calendar-header">
      <h3 style="margin:0; color:var(--accent2);">${monthNames[month]} ${year}</h3>
      <button class="btn btn-secondary" onclick="switchView('calendar', event)">Today</button>
    </div>
    <div class="calendar-grid">
  `;
  
  // Add weekday headers
  weekdays.forEach(day => {
    html += `<div class="calendar-day weekday">${day}</div>`;
  });
  
  // Add empty cells for days before month starts
  for(let i = 0; i < firstDay; i++) {
    html += '<div class="calendar-day" style="background:transparent; border:none;"></div>';
  }
  
  // Collect activity dates from all challenges
  const activityDates = new Set();
  challenges.forEach(c => {
    if (c.notes && Array.isArray(c.notes)) {
      c.notes.forEach(note => {
        const noteDate = new Date(note.date);
        const dateStr = noteDate.toISOString().split('T')[0];
        activityDates.add(dateStr);
      });
    }
  });
  
  // Add days of month
  for(let day = 1; day <= daysInMonth; day++) {
    const date = new Date(year, month, day);
    const dateStr = date.toISOString().split('T')[0];
    const todayStr = today.toISOString().split('T')[0];
    const isToday = dateStr === todayStr;
    const hasActivity = activityDates.has(dateStr);
    
    let classList = 'calendar-day';
    if (isToday) classList += ' today';
    if (hasActivity) classList += ' has-activity';
    
    html += `<div class="${classList}">${day}</div>`;
  }
  
  html += '</div>';
  container.innerHTML = html;
}

function renderChart() {
  const container = document.getElementById('chart-view');
  const activeChallenges = challenges.filter(c => c.status === 'active' || c.status === 'completed');
  
  if(activeChallenges.length === 0) {
    container.innerHTML = '<p style="text-align:center; color:var(--muted); padding:2rem;">No active challenges to chart.</p>';
    return;
  }
  
  let html = '<h3 style="margin-top:0; margin-bottom:1.5rem; color:var(--accent2);">Progress Overview</h3>';
  
  activeChallenges.slice(0, 10).forEach(c => {
    const duration = Math.max(c.duration, 1);
    const progress = Math.min(100, Math.max(0, (c.progress / duration) * 100));
    const progressPercent = Math.round(progress);
    html += `
      <div class="chart-bar">
        <div class="chart-bar-label">${c.name}</div>
        <div class="chart-bar-fill">
          <div class="chart-bar-progress" style="width: ${progress}%">${progressPercent}%</div>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

function renderAchievements() {
  const container = document.getElementById('achievements-view');
  
  // Calculate stats
  const totalHours = Math.floor(challenges.reduce((sum, c) => sum + (c.totalTime || 0), 0) / 60);
  const completedCount = challenges.filter(c => c.status === 'completed').length;
  const activeCount = challenges.filter(c => c.status === 'active').length;
  const maxStreak = Math.max(...challenges.map(c => (c.streak || 0)), 0);
  
  const achievements = [
    { id: 'first', icon: 'üéØ', title: 'First Steps', desc: 'Complete your first challenge', unlocked: completedCount >= 1 },
    { id: 'streak', icon: 'üî•', title: 'On Fire', desc: 'Maintain a 7-day streak', unlocked: maxStreak >= 7 },
    { id: 'dedicated', icon: 'üí™', title: 'Dedicated', desc: 'Complete 5 challenges', unlocked: completedCount >= 5 },
    { id: 'time', icon: '‚è∞', title: 'Time Master', desc: 'Invest 50+ hours total', unlocked: totalHours >= 50 },
    { id: 'variety', icon: 'üåà', title: 'Variety Seeker', desc: 'Have 10+ active challenges', unlocked: activeCount >= 10 },
    { id: 'speed', icon: '‚ö°', title: 'Speed Learner', desc: 'Complete a challenge in 7 days', unlocked: challenges.some(c => {
      if (c.status !== 'completed') return false;
      const start = new Date(c.startDate);
      const end = new Date(c.lastUpdate);
      const daysDiff = (end - start) / (1000 * 60 * 60 * 24);
      return daysDiff <= 7;
    }) }
  ];
  
  let html = '';
  const unlockedCount = achievements.filter(a => a.unlocked).length;
  html += `<div style="grid-column:1/-1; text-align:center; margin-bottom:1rem;"><h3 style="color:var(--accent2); margin:0;">${unlockedCount} / ${achievements.length} Achievements Unlocked</h3></div>`;
  
  achievements.forEach(ach => {
    html += `
      <div class="achievement-card ${ach.unlocked ? 'unlocked' : ''}">
        <div class="achievement-icon">${ach.icon}</div>
        <div class="achievement-title">${ach.title}</div>
        <div class="achievement-desc">${ach.desc}</div>
        ${ach.unlocked ? '<div style="margin-top:0.5rem; color:var(--success); font-weight:600;">‚úì Unlocked</div>' : '<div style="margin-top:0.5rem; color:var(--muted); font-size:0.85rem;">üîí Locked</div>'}
      </div>
    `;
  });
  
  container.innerHTML = html || '<p style="text-align:center; color:var(--muted);">No achievements yet.</p>';
}

function showAchievements() {
  switchView('achievements', {target: document.querySelector('[data-view="achievements"]')});
}

function exportProgress() {
  const data = {
    exportDate: new Date().toISOString(),
    challenges: challenges.map(c => ({
      name: c.name,
      status: c.status,
      progress: c.progress,
      duration: c.duration,
      totalTime: c.totalTime,
      streak: c.streak,
      startDate: c.startDate,
      lastUpdate: c.lastUpdate
    })),
    stats: {
      total: challenges.length,
      active: challenges.filter(c => c.status === 'active').length,
      completed: challenges.filter(c => c.status === 'completed').length,
      totalHours: Math.round(challenges.reduce((sum, c) => sum + (c.totalTime || 0), 0) / 60)
    }
  };
  
  const json = JSON.stringify(data, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `challenges-export-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
}

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
  if(e.key === 'Escape') {
    document.querySelectorAll('.modal.active').forEach(m => m.classList.remove('active'));
  }
  if(e.key === 'n' && (e.ctrlKey || e.metaKey)) {
    e.preventDefault();
    openAddModal();
  }
});

// Auto-save notes
let autoSaveTimeout;
document.addEventListener('input', (e) => {
  if(e.target.matches('#challenge-description, #challenge-name')) {
    clearTimeout(autoSaveTimeout);
    autoSaveTimeout = setTimeout(() => {
      if(editingChallengeId) {
        const challenge = challenges.find(c => c.id === editingChallengeId);
        if(challenge) {
          challenge.name = document.getElementById('challenge-name').value;
          challenge.description = document.getElementById('challenge-description').value;
          saveChallenges();
        }
      }
    }, 1000);
  }
});

// Initialize calendar if needed
if(challenges.length > 0) {
  setTimeout(() => {
    if(document.getElementById('calendar-view').classList.contains('active')) {
      renderCalendar();
    }
  }, 100);
}
let shareLocked = false;

async function shareToday() {
  if (shareLocked) return;
  shareLocked = true;

  const shareText = `I just completed today‚Äôs learning challenge on SpendSomeTime.org üß†‚ú®
Do something better than scrolling.`;

  try {
    if (navigator.share) {
      await navigator.share({
        title: "SpendSomeTime",
        text: shareText,
        url: window.location.href
      });
    } else {
      await navigator.clipboard.writeText(
        shareText + " " + window.location.href
      );
      alert("Link copied!");
    }
  } catch (err) {
    console.warn("Share cancelled or failed:", err);
  }

  // unlock after a short delay
  setTimeout(() => {
    shareLocked = false;
  }, 1000);
}
function showLessonCompleteAnimation(challengeName) {
  const messages = [
    "BRO ACTUALLY FINISHED üò≠",
    "Productivity detected.",
    "Skill unlocked.",
    "This is character development.",
    "Scrolling avoided successfully.",
    "Rare W achieved."
  ];

  const burstIcons = ["üî•", "‚ö°", "üß†", "üèÜ", "‚ú®"];

  const overlay = document.getElementById("lesson-complete-overlay");
  const card = overlay.querySelector(".lesson-complete-card");
  const text = document.getElementById("lesson-complete-text");
  const mainIcon = document.getElementById("main-icon");
  const burst = document.getElementById("icon-burst");

  overlay.style.display = "flex";
  burst.innerHTML = "";

  text.textContent =
    messages[Math.floor(Math.random() * messages.length)] +
    `\n"${challengeName}"`;

  gsap.set(card, {
    opacity: 0,
    y: 80,
    rotateX: -25,
    scale: 0.8
  });

  gsap.set(mainIcon, { scale: 0, rotate: -90 });

  // Create burst icons
  for (let i = 0; i < 12; i++) {
    const el = document.createElement("div");
    el.className = "burst-icon";
    el.textContent = burstIcons[Math.floor(Math.random() * burstIcons.length)];
    burst.appendChild(el);

    gsap.set(el, {
      x: 0,
      y: 0,
      scale: 0.6
    });
  }

  const tl = gsap.timeline({
    onComplete: () =>
      setTimeout(() => {
        gsap.to(card, {
          y: -40,
          opacity: 0,
          scale: 0.9,
          duration: 0.3,
          ease: "power2.in",
          onComplete: () => (overlay.style.display = "none")
        });
      }, 900)
  });

  // Card entrance
  tl.to(card, {
    opacity: 1,
    y: 0,
    rotateX: 0,
    scale: 1,
    duration: 0.6,
    ease: "back.out(1.6)"
  });

  // Icon pop + spin
  tl.to(mainIcon, {
    scale: 1,
    rotate: 0,
    duration: 0.4,
    ease: "elastic.out(1.4, 0.6)"
  }, "-=0.3");

  // Screen punch
  tl.fromTo(card, {
    x: -4
  }, {
    x: 4,
    duration: 0.1,
    repeat: 5,
    yoyo: true,
    ease: "power1.inOut"
  }, "-=0.2");

  // Burst animation
  tl.to(".burst-icon", {
    opacity: 1,
    x: () => gsap.utils.random(-80, 80),
    y: () => gsap.utils.random(-80, 80),
    rotation: () => gsap.utils.random(-180, 180),
    scale: 1,
    duration: 0.6,
    ease: "power3.out",
    stagger: 0.03
  }, "-=0.3");

  // Text snap-in
  tl.from(text, {
    y: 20,
    opacity: 0,
    duration: 0.3,
    ease: "power2.out"
  }, "-=0.4");
}

// ===== THEME MANAGEMENT =====

/**
 * Open the theme selector modal and populate with themes
 */
async function openThemeSelector() {
  const modal = document.getElementById('theme-modal');
  const themeGrid = document.getElementById('theme-grid');
  
  // Clear existing themes
  themeGrid.innerHTML = '';
  
  // Get all themes from ThemeManager
  const themes = ThemeManager.getAllThemes();
  const unlockedThemes = GameSystem.getUnlockedThemes();
  const activeTheme = GameSystem.getActiveTheme();
  
  themes.forEach(theme => {
    const isUnlocked = unlockedThemes.includes(theme.id);
    const isActive = activeTheme === theme.id;
    
    const card = document.createElement('div');
    card.className = `theme-card ${isActive ? 'active' : ''} ${!isUnlocked ? 'locked' : ''}`;
    
    // Create preview box with theme colors
    const preview = document.createElement('div');
    preview.className = 'theme-preview';
    if (theme.cssVariables && theme.cssVariables.accent2) {
      preview.style.background = `linear-gradient(135deg, ${theme.cssVariables.accent}, ${theme.cssVariables.accent2})`;
    }
    
    const name = document.createElement('div');
    name.className = 'theme-name';
    name.textContent = theme.name;
    
    const desc = document.createElement('div');
    desc.className = 'theme-cost';
    desc.textContent = isUnlocked ? '‚úì Unlocked' : `${theme.xpCost} XP`;
    
    const status = document.createElement('div');
    status.className = 'theme-status';
    status.textContent = isActive ? 'üéØ Active' : (isUnlocked ? '‚úì Unlocked' : 'üîí Locked');
    
    card.appendChild(preview);
    card.appendChild(name);
    card.appendChild(desc);
    card.appendChild(status);
    
    // Add click handler
    if (isUnlocked) {
      card.style.cursor = 'pointer';
      card.addEventListener('click', () => {
        applyTheme(theme.id);
        updateThemeGrid();
      });
    } else {
      // Add unlock button
      const unlockBtn = document.createElement('button');
      unlockBtn.className = 'unlock-btn';
      const currentXP = GameSystem.getTotalXP();
      const canAfford = currentXP >= theme.xpCost;
      unlockBtn.disabled = !canAfford;
      unlockBtn.textContent = canAfford ? 'Unlock' : `Need ${theme.xpCost - currentXP} more XP`;
      unlockBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        unlockTheme(theme.id, theme.xpCost);
      });
      card.appendChild(unlockBtn);
    }
    
    themeGrid.appendChild(card);
  });
  
  modal.classList.add('active');
}

/**
 * Close the theme selector modal
 */
function closeThemeSelector() {
  const modal = document.getElementById('theme-modal');
  modal.classList.remove('active');
}

/**
 * Update the theme grid (refresh visuals after theme change/unlock)
 */
function updateThemeGrid() {
  const activeTheme = GameSystem.getActiveTheme();
  document.querySelectorAll('.theme-card').forEach(card => {
    card.classList.remove('active');
  });
  
  // Mark active theme - find it by checking the first matching theme
  const themeCards = document.querySelectorAll('.theme-card');
  const activeIndex = Array.from(themeCards).findIndex(card => 
    card.querySelector('.theme-name').textContent === 
    ThemeManager.themes.find(t => t.id === activeTheme)?.name
  );
  if (activeIndex >= 0) {
    themeCards[activeIndex].classList.add('active');
  }
}

/**
 * Apply a theme without unlocking it (must be unlocked first)
 */
function applyTheme(themeId) {
  if (GameSystem.setActiveTheme(themeId)) {
    ThemeManager.applyTheme(themeId);
    showThemeUnlockedToast(ThemeManager.getTheme(themeId)?.name || 'Theme');
    updateThemeGrid();
    updateStats(); // Update XP display if any rewards changed
  }
}

/**
 * Unlock a theme by spending XP
 */
function unlockTheme(themeId, cost) {
  const result = GameSystem.unlockTheme(themeId, cost);
  
  if (result) {
    // Success! Show celebration
    const theme = ThemeManager.getTheme(themeId);
    showThemeUnlockedCelebration(theme.name);
    
    // Apply the newly unlocked theme
    ThemeManager.applyTheme(themeId);
    GameSystem.setActiveTheme(themeId);
    
    // Update UI
    updateStats();
    openThemeSelector(); // Refresh the modal
  } else {
    // Failed - probably not enough XP
    const userData = GameSystem.getUserData();
    const theme = ThemeManager.getTheme(themeId);
    const needed = theme.xpCost - userData.totalXP;
    alert(`You need ${needed} more XP to unlock "${theme.name}"`);
  }
}

/**
 * Show a toast notification when theme is switched
 */
function showThemeUnlockedToast(themeName) {
  // Remove any existing toasts
  document.querySelectorAll('.xp-toast').forEach(t => t.remove());
  
  const toast = document.createElement('div');
  toast.className = 'xp-toast';
  toast.innerHTML = `<strong>${themeName}</strong> theme activated! üé®`;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideInUp 0.3s ease reverse';
    setTimeout(() => toast.remove(), 300);
  }, 2000);
}

/**
 * Show celebration animation when theme is unlocked
 */
function showThemeUnlockedCelebration(themeName) {
  // Remove any existing celebration
  const existing = document.getElementById('theme-celebration');
  if (existing) existing.remove();
  
  const celebration = document.createElement('div');
  celebration.id = 'theme-celebration';
  celebration.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    color: white;
    padding: 2rem 3rem;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    z-index: 3001;
    text-align: center;
    animation: slideInUp 0.6s ease;
    font-weight: 700;
    font-size: 1.3rem;
  `;
  celebration.innerHTML = `üéâ Unlocked: <strong>${themeName}</strong>`;
  document.body.appendChild(celebration);
  
  setTimeout(() => {
    celebration.style.animation = 'slideInUp 0.3s ease reverse';
    setTimeout(() => celebration.remove(), 300);
  }, 2500);
}

// ===== GAMIFICATION EVENT LISTENERS =====
// (Event listeners are now handled in the enhanced notification functions above)


// Listen for theme change events
window.addEventListener('themeChanged', (e) => {
  const theme = ThemeManager.getTheme(e.detail.themeId);
  if (theme) {
    showThemeUnlockedToast(theme.name);
  }
});

// Listen for gamification updates and refresh XP display
window.addEventListener('gamificationUpdate', () => {
  updateStats();
});

/**
 * Show XP gain toast notification
 */
function showXPToast(amount, source) {
  // Remove any existing XP toasts
  document.querySelectorAll('.xp-toast').forEach(t => t.remove());
  
  const sourceText = {
    'logOfflineSession': 'üéØ Logged a session',
    'completeChallenge': '‚úÖ Completed challenge',
    'logReflection': 'üí≠ Micro win logged',
    'completeQuiz': 'üß† Quiz completed',
    'winGame': 'üéÆ Game won'
  }[source] || '‚≠ê XP earned';
  
  // Get streak info for display
  const streakInfo = typeof GameSystem !== 'undefined' ? GameSystem.getStreakInfo() : null;
  const streakDisplay = streakInfo && streakInfo.current > 0 
    ? `üî• ${streakInfo.current}-day streak (${(streakInfo.multiplier * 100).toFixed(0)}% bonus)`
    : '';
  
  const toast = document.createElement('div');
  toast.className = 'xp-toast';
  toast.innerHTML = `
    <div style="font-weight: 700; font-size: 1.1em; margin-bottom: 0.25rem;">+${amount} XP</div>
    <div style="font-size: 0.9em;">${sourceText}</div>
    ${streakDisplay ? `<div style="font-size: 0.85em; margin-top: 0.25rem;" >${streakDisplay}</div>` : ''}
  `;
  document.body.appendChild(toast);
  
  // Celebration effect with confetti-like particles
  if (amount >= 20) {
    createCelebrationParticles(8);
  }
  
  setTimeout(() => {
    toast.style.animation = 'slideInUp 0.3s ease reverse';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// Create celebration particles for big XP gains
function createCelebrationParticles(count) {
  const colors = ['#ff7eb9', '#58d9ff', '#4ade80', '#fbbf24'];
  
  for (let i = 0; i < count; i++) {
    const particle = document.createElement('div');
    particle.style.position = 'fixed';
    particle.style.pointerEvents = 'none';
    particle.style.fontSize = '1.5rem';
    particle.style.left = (Math.random() * 100) + 'vw';
    particle.style.top = '50vh';
    particle.style.zIndex = '9999';
    particle.textContent = ['‚≠ê', '‚ú®', 'üéâ', 'üéä', 'üí´'][Math.floor(Math.random() * 5)];
    
    document.body.appendChild(particle);
    
    // Animate upward and fade
    const duration = 1500 + Math.random() * 500;
    const yDistance = 200 + Math.random() * 200;
    const xDistance = (Math.random() - 0.5) * 200;
    
    particle.animate([
      { transform: 'translateY(0) translateX(0) scale(1)', opacity: 1 },
      { transform: `translateY(-${yDistance}px) translateX(${xDistance}px) scale(0)`, opacity: 0 }
    ], {
      duration: duration,
      easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)',
      fill: 'forwards'
    });
    
    setTimeout(() => particle.remove(), duration);
  }
}

// Event listeners for enhanced gamification
window.addEventListener('xpGained', (e) => {
  const { amount, source, newAchievements } = e.detail;
  
  showXPToast(amount, source);
  
  // Show achievement notifications
  if (newAchievements && newAchievements.length > 0) {
    setTimeout(() => {
      newAchievements.forEach(achievement => {
        showAchievementNotification(achievement);
      });
    }, 500);
  }
  
  // Update XP display
  if (typeof GameSystem !== 'undefined') {
    updateStats();
  }
});

window.addEventListener('milestoneCelebration', (e) => {
  const { milestone } = e.detail;
  showMilestoneCelebration(milestone);
});

window.addEventListener('themeUnlocked', (e) => {
  const { themeId } = e.detail;
  showThemeUnlockCelebration(themeId);
});

// Show achievement notification
function showAchievementNotification(achievement) {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 100px;
    right: 20px;
    background: linear-gradient(135deg, #ff7eb9, #58d9ff);
    color: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    z-index: 10000;
    max-width: 300px;
    animation: slideInUp 0.5s ease, slideInUp 0.5s ease reverse 4.5s forwards;
    font-weight: 600;
  `;
  notification.innerHTML = `
    <div style="font-size: 1.3em; margin-bottom: 0.5rem;">${achievement.name}</div>
    <div style="font-size: 0.9em; opacity: 0.9;">${achievement.desc}</div>
  `;
  document.body.appendChild(notification);
  
  createCelebrationParticles(12);
  
  setTimeout(() => notification.remove(), 5000);
}

// Show milestone celebration
function showMilestoneCelebration(milestone) {
  const celebration = document.createElement('div');
  celebration.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(135deg, #fbbf24, #ff7eb9);
    color: white;
    padding: 3rem;
    border-radius: 16px;
    text-align: center;
    z-index: 10001;
    max-width: 90%;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    animation: popIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
  `;
  celebration.innerHTML = `
    <div style="font-size: 3em; margin-bottom: 1rem;">üèÜ</div>
    <div style="font-size: 2.5em; font-weight: 700; margin-bottom: 0.5rem;">${milestone} XP Milestone!</div>
    <div style="font-size: 1.1em; opacity: 0.95;">You're on fire! üî•</div>
  `;
  document.body.appendChild(celebration);
  
  createCelebrationParticles(20);
  
  setTimeout(() => {
    celebration.style.animation = 'popIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) reverse';
    setTimeout(() => celebration.remove(), 600);
  }, 3000);
}

// Show theme unlock celebration
function showThemeUnlockCelebration(themeId) {
  const celebration = document.createElement('div');
  celebration.style.cssText = `
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: linear-gradient(135deg, #58d9ff, #4ade80);
    color: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    z-index: 10000;
    max-width: 280px;
    animation: slideInUp 0.5s ease, slideInUp 0.5s ease reverse 4.5s forwards;
    font-weight: 600;
    text-align: center;
  `;
  celebration.innerHTML = `
    <div style="font-size: 1.5em; margin-bottom: 0.5rem;">üé® New Theme Unlocked!</div>
    <div style="font-size: 0.95em;">Check it out in preferences! ‚ú®</div>
  `;
  document.body.appendChild(celebration);
  
  createCelebrationParticles(10);
  
  setTimeout(() => celebration.remove(), 5000);
}


</script>

<div id="lesson-complete-overlay">
  <div class="lesson-complete-card">
    <p class="lesson-sub">Your lesson is complete!</p>
    <div class="icon-burst" id="icon-burst"></div>
<i class="main-icon lucide lucide-trophy" id="main-icon"></i>
<div class="duo-icon">
  ‚úì
</div>
<div class="sparkles" id="sparkles"></div>
<p id="lesson-complete-text"></p>
  </div>
</div>
<footer>
  <div class="footer-content">
    <p>¬© 2026 SpendSomeTime: Use your time with purpose</p>
    <div class="footer-links">
      <a href="privacy-policy.html">Privacy Policy</a>
      <a href="mailto:contact@spendsometime.org">Contact Us</a>
    </div>
  </div>
</footer>
</body>
</html>

